on:
  schedule:
    - cron: "0 14 * * *" # daily, UTC 14 = PT 07

permissions:
  actions: write

jobs:
  auto-release-stable:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - id: get-latest
        run: |
          set -euo pipefail
          response=$(curl -f -s "https://cdn.crabnebula.app/update/fastrepl/hyprnote/darwin-aarch64/latest?channel=nightly")
          latest_version=$(echo "$response" | jq -r '.version')
          echo "latest_version=$latest_version" >> $GITHUB_OUTPUT

      - id: get-current
        run: |
          set -euo pipefail
          current_version=$(jq -r '.package.version' apps/desktop/src-tauri/tauri.conf.json)
          echo "current_version=$current_version" >> $GITHUB_OUTPUT

      - id: compare-versions
        uses: jackbilestech/semver-compare@1.0.4
        continue-on-error: true
        with:
          head: ${{ steps.get-latest.outputs.latest_version }}
          base: ${{ steps.get-current.outputs.current_version }}
          operator: ">"

      - id: set-result
        run: |
          if [[ "${{ steps.compare-versions.outcome }}" == "success" ]]; then
            echo "new_version_available=true" >> $GITHUB_OUTPUT
          else
            echo "new_version_available=false" >> $GITHUB_OUTPUT
          fi

      - if: steps.set-result.outputs.new_version_available == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'desktop_cd.yaml',
              ref: 'main'
            })
